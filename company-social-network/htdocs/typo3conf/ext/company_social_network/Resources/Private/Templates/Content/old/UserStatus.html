<div xmlns="http://www.w3.org/1999/xhtml" lang="en"
     xmlns:f="http://typo3.org/ns/TYPO3/Fluid/ViewHelpers"
     xmlns:flux="http://typo3.org/ns/FluidTYPO3/Flux/ViewHelpers"
     xmlns:v="http://typo3.org/ns/FluidTYPO3/Vhs/ViewHelpers">

    <f:layout name="Content"/>

    <f:section name="Configuration">
        <flux:form id="example" options="{group: 'FCE'}" label="User Status Ajax" description="Lista user status">

        </flux:form>
    </f:section>

    <f:section name="Preview">
        <strong>USER STATUS AJAX</strong><br/>

    </f:section>

    <f:section name="Main">
        <v:page.header.link rel="stylesheet" href="/fileadmin/templates/css/userStatus.css"/>
        <div class="status-info">
            <h3 class="status-title">Utente: {user.username}
                <span id="status-label" 
                        class="pull-right label {f:if(condition:'{user.online}',then:'label-success',else:'label-default')}">
                    
                    <span   id="status-icon" 
                            class="glyphicon glyphicon-eye-{f:if(condition:'{user.online}',then:'open',else:'close')}"
                            aria-hidden="true">
                    </span>
                    <span id="status-text">{f:if(condition:'{user.online}',then:'online',else:'offline')}</span>
                </span>              
            </h3>

            <button id="toggle-status-button" class="btn
                {f:if(condition:'{user.online}',then:'btn-default',else:'btn-success')}
                btn-xs btn-block">
                <f:if condition="{user.online}">
                    <f:then>
                        <span id="status-button-label">Passa offline1234</span>
                            <span id="status-button-icon" class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
                    </f:then>
                    <f:else>
                        <span id="status-button-label">Passa online777</span>
                        <span id="status-button-icon" class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                    </f:else>
                </f:if>
            </button>
      </div>

        <script type="text/javascript">
            $( document ).ready(function() {
                
                CSND.debug = true;
                CSND.log();

                $("#toggle-status-button").click( ()=> {

                    var tsb =  $("#toggle-status-button");
                    tsb.button("loading");
           
                    $.post( "/rest/user/status/toggle", (response) => {
                        
                        if(response.status == "ok"){

                            var st = $("#status-text");
                            var sl = $("#status-label");
                            var tsb = $("#toggle-status-button");
                            var si = $("#status-icon");
                            var sbi = $("#status-button-icon");
                            var sbl = $("#status-button-label");

                            tsb.button("reset");

                            if (response.data.online){
                                st.text("online");
                                tsb.removeClass("btn-success").addClass("btn-default");
                                sl.removeClass("label-default").addClass("label-success");
                                si.removeClass("glyphicon-eye-close").addClass("glyphicon-eye-open");
                                sbi.removeClass("glyphicon-eye-open").addClass("glyphicon-eye-close");
                                sbl.text('Passa online888');
                            } else {
                                st.text("offline");
                                tsb.removeClass("btn-default").addClass("btn-success");
                                sl.removeClass("label-success").addClass("label-default");
                                si.removeClass("glyphicon-eye-open").addClass("glyphicon-eye-close");
                                sbi.removeClass("glyphicon-eye-close").addClass("glyphicon-eye-open");
                                sbl.text('Passa online');
                            }
                        }

                    }).fail((error) => {
                        //??
                    });
                })
            });
        </script>
    </f:section>
</div>
